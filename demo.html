<!DOCTYPE html>
<html>
<head>
  <title>打卡</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="description" content="">

  <link rel="stylesheet" href="public/assetswap/lib/dist/lib/weui.min.css">
  <link rel="stylesheet" href="public/assetswap/lib/dist/css/jquery-weui.min.css">
  <link rel="stylesheet" href="public/assetswap/lib/css/common.css">
  <link rel="stylesheet" href="public/assetswap/signin/css/style.css">

</head>
<body ontouchstart>
<div class="p-signin">
  <div class="m-signin-date">--年--月--日</div>
  <div class="m-signin-time">--:--:--</div>
  <div class="m-signin-bg">
    <img src="public/assetswap/signin/img/bg.png">
    <!--<div class='uil-ripple-css' style='transform:scale(1);'>-->
    <!--<div></div>-->
    <!--<div></div>-->
    <!--<div></div>-->
    <!--<div></div>-->
    <!--<div></div>-->
    <!--<div></div>-->
    <!--</div>-->
  </div>
  <div class="m-signin-action">
    <a href="javascript:;" class="weui_btn weui_btn_blue sign_in">请打卡</a>
  </div>
</div>
<script src="public/assetswap/lib/dist/lib/jquery-2.1.4.js"></script>
<script src="public/assetswap/lib/dist/lib/fastclick.js"></script>
<script>
  //        $(function() {
  //            FastClick.attach(document.body);
  //        });
</script>
<script src="public/assetswap/lib/dist/js/jquery-weui.js"></script>
<script src="public/assetswap/lib/js/common2.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
  var data = <?php echo $data; ?>;
  wx.config({
    debug: false,
    appId: data.data.appId,
    timestamp: data.data.timestamp,
    nonceStr: data.data.nonceStr,
    signature: data.data.signature,
    jsApiList: [
      // 所有要调用的 API 都要加到这个列表中
      'checkJsApi',
      'openLocation',
      'getLocation'
    ]
  });
  wx.ready(function () {
    wx.checkJsApi({
      jsApiList: [
        'getLocation'
      ],
      success: function (res) {
        if (res.checkResult.getLocation == false) {
          alert('你的微信版本太低，不支持微信JS接口，请升级到最新的微信版本！');
          return;
        }
      }
    });
    wx.getLocation({
      type: 'gcj02', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
      success: function (res) {
        var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
        var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
        alert(res.latitude+'  '+res.longitude);
        var speed = res.speed; // 速度，以米/每秒计
        var accuracy = res.accuracy; // 位置精度
        var redirectUri = encodeURIComponent(data.data.redirectUri+'&latitude='+latitude+'&longitude='+longitude);
        var getCodeUrl = data.data.getCodeUrl;
        getCodeUrl = getCodeUrl.replace('redirectUri',redirectUri);
        $(".sign_in").one("click",function(){
          $.showLoading("正在加载...");
          window.location.href = getCodeUrl;
        });
        //运动事件监听
        if (window.DeviceMotionEvent) {
          window.addEventListener('devicemotion',deviceMotionHandler,false);
        }
        //获取加速度信息
        //通过监听上一步获取到的x, y, z 值在一定时间范围内的变化率，进行设备是否有进行晃动的判断。
        //而为了防止正常移动的误判，需要给该变化率设置一个合适的临界值。
        var SHAKE_THRESHOLD = 8000;
        var last_update = 0;
        var x, y, z, last_x = 0, last_y = 0, last_z = 0;
        var isFirst = true;
        function deviceMotionHandler(eventData) {
          var acceleration =eventData.accelerationIncludingGravity;
          var curTime = new Date().getTime();
          if ((curTime-last_update)> 10) {
            var diffTime = curTime -last_update;
            last_update = curTime;
            x = acceleration.x;
            y = acceleration.y;
            z = acceleration.z;
            var speed = Math.abs(x +y + z - last_x - last_y - last_z) / diffTime * 10000;
            if (speed > SHAKE_THRESHOLD) {
              $.showLoading("正在加载...");
              if(isFirst) {
                isFirst = false;
                var audio = new Audio("public/assetswap/signin/img/ring.mp3");
                audio.play();
                window.setTimeout(function(){
                  window.location.href = getCodeUrl;
                },1000);
              }
            }
            last_x = x;
            last_y = y;
            last_z = z;
          }
        }
      },
      fail: function (res) {
        alert('微信定位功能不可用，请检查是否打开GPS定位');
      }
    });
  });
  $('.m-signin-date').html(getNowFormatDate());
  $('.m-signin-time').html(getTime());
  function getNowFormatDate() {
    var date = new Date();
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    if (month >= 1 && month <= 9) {
      month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
      strDate = "0" + strDate;
    }
    var currentdate = year + '年' + month + '月' + strDate + '日';
    return currentdate;
  }
  window.setInterval(function () {
    $('.m-signin-time').html(getTime());
  }, 1000);
  function getTime() {
    var date = new Date();
    var seperator = ":";
    var hour = date.getHours();
    var minute = date.getMinutes();
    var second = date.getSeconds();
    if (hour >= 0 && hour <= 9) {
      hour = "0" + hour;
    }
    if (minute >= 0 && minute <= 9) {
      minute = "0" + minute;
    }
    if (second >= 0 && second <= 9) {
      second = "0" + second;
    }
    var currentTime = hour + seperator + minute + seperator + second;
    return currentTime;
  }
</script>
</body>
</html>
